import{a as ce,b as P,c as me,d as de}from"./chunk-5BYDZPPU.js";import{$ as Q,A as b,E as $,F as u,Ga as k,Ha as ie,I as g,Ia as I,Ja as re,Ka as ne,Ma as se,N as L,O as U,Oa as ae,Pa as le,Qa as pe,U as l,V as p,W as x,X as c,Y as d,_ as H,ba as z,c as F,ca as y,e as v,fa as q,ga as Z,h as V,ha as ee,i as _,j as G,l as Y,la as s,m as f,ma as te,na as K,p as E,s as n,t as D,u as X,x as J,xa as oe,y as S,z as A}from"./chunk-F66V2PF3.js";var ue=[{path:"",redirectTo:"catalog",pathMatch:"full"},{path:"catalog",loadComponent:()=>import("./chunk-QCNVXAIR.js").then(o=>o.CatalogPageComponent)},{path:"video/:id",loadComponent:()=>import("./chunk-4XPDC5GU.js").then(o=>o.VideoPageComponent)},{path:"progress",loadComponent:()=>import("./chunk-4VXJH55Y.js").then(o=>o.ProgressPageComponent)}];var m={production:!0,apiBaseUrl:"https://german-flow-y1ki.onrender.com/api",googleClientId:"367457967036-9s7q0n3jaf5j90e7l3rjsc6lom9msobm.apps.googleusercontent.com"};var h=class o{http=n(I);TOKEN_KEY="gf_auth_token";USER_KEY="gf_user_data";currentUser=S(this.getStoredUser());token=S(localStorage.getItem(this.TOKEN_KEY));isAuthenticated=S(!!this.token());isLoggedIn(){return this.isAuthenticated()}me(){return this.http.get(`${m.apiBaseUrl}/me`).pipe(f(e=>{this.currentUser.set(e),localStorage.setItem(this.USER_KEY,JSON.stringify(e))}))}initializeGoogleLogin(e){if(typeof window.google>"u"){setTimeout(()=>this.initializeGoogleLogin(e),100);return}window.google.accounts.id.initialize({client_id:m.googleClientId,callback:t=>this.handleGoogleResponse(t)}),window.google.accounts.id.renderButton(e,{theme:"outline",size:"medium",type:"standard",shape:"pill",text:"signin_with",logo_alignment:"left"})}handleGoogleResponse(e){this.loginWithGoogle(e.credential).subscribe({next:()=>{},error:t=>console.error("Auth error:",t)})}loginWithGoogle(e){return this.http.post(`${m.apiBaseUrl}/auth/google`,{idToken:e}).pipe(f(t=>{this.setSession(t)}))}logout(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY),this.token.set(null),this.currentUser.set(null),this.isAuthenticated.set(!1),typeof window.google<"u"&&window.google.accounts.id.disableAutoSelect()}setSession(e){localStorage.setItem(this.TOKEN_KEY,e.accessToken),localStorage.setItem(this.USER_KEY,JSON.stringify(e.user)),this.token.set(e.accessToken),this.currentUser.set(e.user),this.isAuthenticated.set(!0)}getStoredUser(){let e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}static \u0275fac=function(t){return new(t||o)};static \u0275prov=E({token:o,factory:o.\u0275fac,providedIn:"root"})};var ge=(o,e)=>{let i=n(h).token();if(i&&o.url.startsWith(m.apiBaseUrl)){let r=o.clone({setHeaders:{Authorization:`Bearer ${i}`}});return e(r)}return e(o)};var he={providers:[J(),le(ue,pe()),re(ne([ge]))]};var be=["googleButtonContainer"];function Ce(o,e){if(o&1){let t=H();c(0,"img",10),z("error",function(){D(t);let r=y(2);return X(r.onAvatarError())}),d()}if(o&2){let t,i=y(2);Q("src",(t=i.auth.currentUser())==null?null:t.avatarUrl,$)}}function Ae(o,e){if(o&1&&(c(0,"div",6),s(1),d()),o&2){let t,i=y(2);u(),K(" ",(((t=i.auth.currentUser())==null?null:t.displayName)||"U")[0].toUpperCase()," ")}}function we(o,e){if(o&1){let t=H();c(0,"div",2)(1,"div",4),L(2,Ce,1,1,"img",5)(3,Ae,2,1,"div",6),d(),c(4,"span",7),s(5),d(),c(6,"button",8),z("click",function(){D(t);let r=y();return X(r.onLogout())}),c(7,"span",9),s(8,"logout"),d()()()}if(o&2){let t,i,r=y();u(2),U((t=r.auth.currentUser())!=null&&t.avatarUrl?2:3),u(3),K(" ",(i=r.auth.currentUser())==null?null:i.displayName," ")}}function _e(o,e){o&1&&(c(0,"div",11),s(1," Loading auth... "),d())}function Ee(o,e){if(o&1&&(c(0,"div",3,0),L(2,_e,2,0,"div",11),d()),o&2){let t=y();u(2),U(t.isLoading()?2:-1)}}var M=class o{auth=n(h);isLoading=S(!0);constructor(){A(()=>{let e=this.auth.currentUser();e&&console.log("AuthButton: Current user avatar URL:",e.avatarUrl)})}set googleButton(e){e&&(this.auth.initializeGoogleLogin(e.nativeElement),this.isLoading.set(!1))}ngAfterViewInit(){this.auth.isAuthenticated()||setTimeout(()=>{this.isLoading.set(!1)},3e3)}onLogout(){this.auth.logout()}onAvatarError(){console.error("AuthButton: Failed to load avatar image from URL:",this.auth.currentUser()?.avatarUrl)}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=g({type:o,selectors:[["app-auth-button"]],viewQuery:function(t,i){if(t&1&&q(be,5),t&2){let r;Z(r=ee())&&(i.googleButton=r.first)}},decls:3,vars:1,consts:[["googleButtonContainer",""],[1,"flex","items-center","gap-4"],[1,"flex","items-center","gap-3","bg-gray-50","dark:bg-white/5","pl-1","pr-3","py-1","rounded-full","border","border-[#f0f0eb]","dark:border-[#33332a]"],[1,"min-h-[40px]","flex","items-center"],[1,"relative","size-8","flex-shrink-0"],["referrerpolicy","no-referrer","crossorigin","anonymous","alt","User avatar",1,"size-full","rounded-full","object-cover","ring-2","ring-white","dark:ring-gray-800","shadow-sm",3,"src"],[1,"size-full","rounded-full","bg-primary","flex","items-center","justify-center","text-text-primary","font-bold","text-sm","shadow-sm","ring-2","ring-white","dark:ring-gray-800"],[1,"text-sm","font-bold","text-text-primary","dark:text-white","max-w-[120px]","truncate","hidden","sm:block"],["title","Logout",1,"ml-1","p-1","hover:text-red-500","transition-colors","cursor-pointer","flex","items-center","justify-center",3,"click"],[1,"material-symbols-outlined","!text-[20px]"],["referrerpolicy","no-referrer","crossorigin","anonymous","alt","User avatar",1,"size-full","rounded-full","object-cover","ring-2","ring-white","dark:ring-gray-800","shadow-sm",3,"error","src"],[1,"text-xs","text-text-secondary","animate-pulse","px-4","py-2","bg-gray-50","rounded-full","border","border-dashed","border-gray-200"]],template:function(t,i){t&1&&(c(0,"div",1),L(1,we,9,2,"div",2)(2,Ee,3,1,"div",3),d()),t&2&&(u(),U(i.auth.isAuthenticated()?1:2))},dependencies:[k],styles:["[_nghost-%COMP%]{display:block}"]})};var B=class o{xpService=n(P);displayXp=oe(()=>`${this.xpService.getXp().toLocaleString()} XP`);static \u0275fac=function(t){return new(t||o)};static \u0275cmp=g({type:o,selectors:[["app-header"]],decls:20,vars:1,consts:[[1,"flex","shrink-0","items-center","justify-between","whitespace-nowrap","border-b","border-solid","border-b-[#f5f5f0]","bg-white","dark:bg-[#1a1a0b]","dark:border-[#33332a]","px-10","py-3","z-20"],["routerLink","/",1,"flex","items-center","gap-4","text-text-primary","dark:text-white","hover:opacity-80","transition-opacity"],[1,"size-8","flex","items-center","justify-center","bg-primary","rounded-lg","text-text-primary"],[1,"material-symbols-outlined"],[1,"text-text-primary","dark:text-white","text-xl","font-bold","leading-tight","tracking-[-0.015em]"],[1,"flex","flex-1","justify-end","gap-8"],[1,"flex","items-center","gap-9","hidden","md:flex"],["routerLink","/catalog",1,"text-text-primary","dark:text-white","text-sm","font-medium","leading-normal","hover:text-primary","transition-colors"],["routerLink","/progress",1,"text-text-primary","dark:text-white","text-sm","font-medium","leading-normal","hover:text-primary","transition-colors"],[1,"flex","items-center","gap-3"],[1,"flex","min-w-[84px]","cursor-pointer","items-center","justify-center","overflow-hidden","rounded-full","h-10","px-4","bg-primary","text-text-primary","text-sm","font-bold","leading-normal","shadow-sm","hover:shadow-md","transition-all"],[1,"material-symbols-outlined","!text-[20px]","mr-1"],[1,"truncate"]],template:function(t,i){t&1&&(l(0,"header",0)(1,"a",1)(2,"div",2)(3,"span",3),s(4,"school"),p()(),l(5,"h2",4),s(6,"German Flow"),p()(),l(7,"div",5)(8,"nav",6)(9,"a",7),s(10,"Catalog"),p(),l(11,"a",8),s(12,"My Progress"),p()(),l(13,"div",9)(14,"button",10)(15,"span",11),s(16,"bolt"),p(),l(17,"span",12),s(18),p()(),x(19,"app-auth-button"),p()()()),t&2&&(u(18),te(i.displayXp()))},dependencies:[ae,k,M],encapsulation:2})};var N=class o{http=n(I);auth=n(h);xpService=n(P);wordsRepo=n(me);progressService=n(de);exerciseProgress=n(ce);pushSubject=new F;isHydrating=!1;lastPushedPayloadString=null;constructor(){A(()=>{this.auth.isAuthenticated()&&(console.log("SyncService: User logged in, triggering pull..."),b(()=>this.pullState()))}),A(()=>{this.xpService.totalXp(),this.xpService.xpLog(),this.wordsRepo.getAll(),this.progressService.lastLessonId(),this.exerciseProgress.getAttempts(),!this.isHydrating&&(this.auth.isAuthenticated()?b(()=>{this.pushSubject.next()}):b(()=>{localStorage.setItem("gf.sync.localDirty","1"),console.log("SyncService: Local change detected while logged out. Flagging for merge.")}))}),this.pushSubject.pipe(G(2e3),V(()=>this.auth.isAuthenticated()&&!this.isHydrating),Y(()=>this.pushState())).subscribe()}pullState(){this.isHydrating=!0,this.http.get(`${m.apiBaseUrl}/state`).pipe(f(()=>console.log("SyncService: Pull success")),_(e=>(console.warn("SyncService: Pull failed",e),v(null)))).subscribe(e=>{if(e)if(localStorage.getItem("gf.sync.localDirty")==="1"){console.log("SyncService: Merging local progress into account...");let i={totalXp:this.xpService.getXp(),xpLog:this.xpService.getLog(),myWords:this.wordsRepo.getAll(),exerciseAttempts:this.exerciseProgress.getAttempts(),lastLessonId:this.progressService.lastLessonId()},r=this.mergeStates(e,i);b(()=>{this.xpService.hydrate(r.totalXp,r.xpLog),this.wordsRepo.hydrate(r.myWords),this.progressService.hydrate(r.lastLessonId),this.exerciseProgress.hydrate(r.exerciseAttempts),this.lastPushedPayloadString=JSON.stringify(r),this.http.post(`${m.apiBaseUrl}/state`,r).pipe(f(()=>console.log("SyncService: Merged state pushed successfully")),_(()=>v(null))).subscribe()}),localStorage.removeItem("gf.sync.localDirty")}else b(()=>{this.xpService.hydrate(e.totalXp,e.xpLog||[]),this.wordsRepo.hydrate(e.myWords||[]),this.progressService.hydrate(e.lastLessonId),this.exerciseProgress.hydrate(e.exerciseAttempts||[]),this.lastPushedPayloadString=JSON.stringify(e)});setTimeout(()=>{this.isHydrating=!1,console.log("SyncService: Hydration lock released")},0)})}mergeStates(e,t){let i=Math.max(e.totalXp||0,t.totalXp||0),r=Array.from(new Set([...e.myWords||[],...t.myWords||[]])),fe=t.lastLessonId||e.lastLessonId,xe=[...e.exerciseAttempts||[],...t.exerciseAttempts||[]],T=new Map;xe.forEach(a=>{let C=T.get(a.exerciseId);(!C||a.ts>C.ts||a.isCorrect&&!C.isCorrect)&&T.set(a.exerciseId,a)});let ye=Array.from(T.values()),ve=[...e.xpLog||[],...t.xpLog||[]],W=new Map;ve.forEach(a=>W.set(a.ts,a));let Se=Array.from(W.values()).sort((a,C)=>C.ts-a.ts).slice(0,50);return{totalXp:i,xpLog:Se,myWords:r,exerciseAttempts:ye,lastLessonId:fe}}pushState(){if(this.isHydrating)return v(null);let e={totalXp:this.xpService.getXp(),xpLog:this.xpService.getLog(),myWords:this.wordsRepo.getAll(),exerciseAttempts:this.exerciseProgress.getAttempts(),lastLessonId:this.progressService.lastLessonId()},t=JSON.stringify(e);return t===this.lastPushedPayloadString?(console.log("SyncService: Skipping push, payload unchanged"),v(null)):this.http.post(`${m.apiBaseUrl}/state`,e).pipe(f(()=>{console.log("SyncService: Push success"),this.lastPushedPayloadString=t}),_(i=>(console.warn("SyncService: Push failed",i),v(null))))}static \u0275fac=function(t){return new(t||o)};static \u0275prov=E({token:o,factory:o.\u0275fac,providedIn:"root"})};var j=class o{syncService=n(N);static \u0275fac=function(t){return new(t||o)};static \u0275cmp=g({type:o,selectors:[["app-shell"]],decls:4,vars:0,consts:[[1,"bg-background-light","dark:bg-background-dark","font-display","text-text-primary","antialiased","h-screen","flex","flex-col","overflow-hidden"],[1,"flex-1","flex","flex-col","min-h-0","overflow-hidden"]],template:function(t,i){t&1&&(l(0,"div",0),x(1,"app-header"),l(2,"div",1),x(3,"router-outlet"),p()())},dependencies:[se,B],styles:["[_nghost-%COMP%]{display:block;height:100vh}"]})};var R=class o{static \u0275fac=function(t){return new(t||o)};static \u0275cmp=g({type:o,selectors:[["app-root"]],decls:1,vars:0,template:function(t,i){t&1&&x(0,"app-shell")},dependencies:[j],encapsulation:2})};ie(R,he).catch(o=>console.error(o));
