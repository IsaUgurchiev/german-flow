import{a as I,b as le,c as pe}from"./chunk-BOELDFQ6.js";import{$ as J,A as S,E as Y,F as m,Fa as U,Ga as te,Ha as k,I as u,Ia as oe,Ja as ie,La as re,N as A,Na as ne,O as L,Oa as ae,Pa as se,U as s,V as l,W as f,X as p,Y as d,_ as D,ba as X,c as O,ca as y,e as x,fa as $,ga as Q,h as W,ha as q,i as _,j as F,l as V,la as a,m as h,ma as Z,na as H,p as E,s as n,t as R,u as T,x as G,xa as ee,y as v,z as b}from"./chunk-QZ362A5T.js";var ce=[{path:"",redirectTo:"catalog",pathMatch:"full"},{path:"catalog",loadComponent:()=>import("./chunk-ZGCDG56K.js").then(o=>o.CatalogPageComponent)},{path:"video/:id",loadComponent:()=>import("./chunk-FXCJC6XM.js").then(o=>o.VideoPageComponent)},{path:"progress",loadComponent:()=>import("./chunk-7KQCUQUQ.js").then(o=>o.ProgressPageComponent)}];var c={production:!0,apiBaseUrl:"https://german-flow-y1ki.onrender.com/api",googleClientId:"367457967036-9s7q0n3jaf5j90e7l3rjsc6lom9msobm.apps.googleusercontent.com"};var g=class o{http=n(k);TOKEN_KEY="gf_auth_token";USER_KEY="gf_user_data";currentUser=v(this.getStoredUser());token=v(localStorage.getItem(this.TOKEN_KEY));isAuthenticated=v(!!this.token());isLoggedIn(){return this.isAuthenticated()}me(){return this.http.get(`${c.apiBaseUrl}/me`).pipe(h(e=>{this.currentUser.set(e),localStorage.setItem(this.USER_KEY,JSON.stringify(e))}))}initializeGoogleLogin(e){if(typeof window.google>"u"){setTimeout(()=>this.initializeGoogleLogin(e),100);return}window.google.accounts.id.initialize({client_id:c.googleClientId,callback:t=>this.handleGoogleResponse(t)}),window.google.accounts.id.renderButton(e,{theme:"outline",size:"medium",type:"standard",shape:"pill",text:"signin_with",logo_alignment:"left"})}handleGoogleResponse(e){this.loginWithGoogle(e.credential).subscribe({next:()=>{},error:t=>console.error("Auth error:",t)})}loginWithGoogle(e){return this.http.post(`${c.apiBaseUrl}/auth/google`,{idToken:e}).pipe(h(t=>{this.setSession(t)}))}logout(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY),this.token.set(null),this.currentUser.set(null),this.isAuthenticated.set(!1),typeof window.google<"u"&&window.google.accounts.id.disableAutoSelect()}setSession(e){localStorage.setItem(this.TOKEN_KEY,e.accessToken),localStorage.setItem(this.USER_KEY,JSON.stringify(e.user)),this.token.set(e.accessToken),this.currentUser.set(e.user),this.isAuthenticated.set(!0)}getStoredUser(){let e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}static \u0275fac=function(t){return new(t||o)};static \u0275prov=E({token:o,factory:o.\u0275fac,providedIn:"root"})};var de=(o,e)=>{let i=n(g).token();if(i&&o.url.startsWith(c.apiBaseUrl)){let r=o.clone({setHeaders:{Authorization:`Bearer ${i}`}});return e(r)}return e(o)};var me={providers:[G(),ae(ce,se()),oe(ie([de]))]};var ye=["googleButtonContainer"];function xe(o,e){if(o&1){let t=D();p(0,"img",10),X("error",function(){R(t);let r=y(2);return T(r.onAvatarError())}),d()}if(o&2){let t,i=y(2);J("src",(t=i.auth.currentUser())==null?null:t.avatarUrl,Y)}}function ve(o,e){if(o&1&&(p(0,"div",6),a(1),d()),o&2){let t,i=y(2);m(),H(" ",(((t=i.auth.currentUser())==null?null:t.displayName)||"U")[0].toUpperCase()," ")}}function Se(o,e){if(o&1){let t=D();p(0,"div",2)(1,"div",4),A(2,xe,1,1,"img",5)(3,ve,2,1,"div",6),d(),p(4,"span",7),a(5),d(),p(6,"button",8),X("click",function(){R(t);let r=y();return T(r.onLogout())}),p(7,"span",9),a(8,"logout"),d()()()}if(o&2){let t,i,r=y();m(2),L((t=r.auth.currentUser())!=null&&t.avatarUrl?2:3),m(3),H(" ",(i=r.auth.currentUser())==null?null:i.displayName," ")}}function be(o,e){o&1&&(p(0,"div",11),a(1," Loading auth... "),d())}function Ce(o,e){if(o&1&&(p(0,"div",3,0),A(2,be,2,0,"div",11),d()),o&2){let t=y();m(2),L(t.isLoading()?2:-1)}}var P=class o{auth=n(g);isLoading=v(!0);constructor(){b(()=>{let e=this.auth.currentUser();e&&console.log("AuthButton: Current user avatar URL:",e.avatarUrl)})}set googleButton(e){e&&(this.auth.initializeGoogleLogin(e.nativeElement),this.isLoading.set(!1))}ngAfterViewInit(){this.auth.isAuthenticated()||setTimeout(()=>{this.isLoading.set(!1)},3e3)}onLogout(){this.auth.logout()}onAvatarError(){console.error("AuthButton: Failed to load avatar image from URL:",this.auth.currentUser()?.avatarUrl)}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=u({type:o,selectors:[["app-auth-button"]],viewQuery:function(t,i){if(t&1&&$(ye,5),t&2){let r;Q(r=q())&&(i.googleButton=r.first)}},decls:3,vars:1,consts:[["googleButtonContainer",""],[1,"flex","items-center","gap-4"],[1,"flex","items-center","gap-3","bg-gray-50","dark:bg-white/5","pl-1","pr-3","py-1","rounded-full","border","border-[#f0f0eb]","dark:border-[#33332a]"],[1,"min-h-[40px]","flex","items-center"],[1,"relative","size-8","flex-shrink-0"],["referrerpolicy","no-referrer","crossorigin","anonymous","alt","User avatar",1,"size-full","rounded-full","object-cover","ring-2","ring-white","dark:ring-gray-800","shadow-sm",3,"src"],[1,"size-full","rounded-full","bg-primary","flex","items-center","justify-center","text-text-primary","font-bold","text-sm","shadow-sm","ring-2","ring-white","dark:ring-gray-800"],[1,"text-sm","font-bold","text-text-primary","dark:text-white","max-w-[120px]","truncate","hidden","sm:block"],["title","Logout",1,"ml-1","p-1","hover:text-red-500","transition-colors","cursor-pointer","flex","items-center","justify-center",3,"click"],[1,"material-symbols-outlined","!text-[20px]"],["referrerpolicy","no-referrer","crossorigin","anonymous","alt","User avatar",1,"size-full","rounded-full","object-cover","ring-2","ring-white","dark:ring-gray-800","shadow-sm",3,"error","src"],[1,"text-xs","text-text-secondary","animate-pulse","px-4","py-2","bg-gray-50","rounded-full","border","border-dashed","border-gray-200"]],template:function(t,i){t&1&&(p(0,"div",1),A(1,Se,9,2,"div",2)(2,Ce,3,1,"div",3),d()),t&2&&(m(),L(i.auth.isAuthenticated()?1:2))},dependencies:[U],styles:["[_nghost-%COMP%]{display:block}"]})};var B=class o{xpService=n(I);displayXp=ee(()=>`${this.xpService.getXp().toLocaleString()} XP`);static \u0275fac=function(t){return new(t||o)};static \u0275cmp=u({type:o,selectors:[["app-header"]],decls:20,vars:1,consts:[[1,"flex","shrink-0","items-center","justify-between","whitespace-nowrap","border-b","border-solid","border-b-[#f5f5f0]","bg-white","dark:bg-[#1a1a0b]","dark:border-[#33332a]","px-10","py-3","z-20"],["routerLink","/",1,"flex","items-center","gap-4","text-text-primary","dark:text-white","hover:opacity-80","transition-opacity"],[1,"size-8","flex","items-center","justify-center","bg-primary","rounded-lg","text-text-primary"],[1,"material-symbols-outlined"],[1,"text-text-primary","dark:text-white","text-xl","font-bold","leading-tight","tracking-[-0.015em]"],[1,"flex","flex-1","justify-end","gap-8"],[1,"flex","items-center","gap-9","hidden","md:flex"],["routerLink","/catalog",1,"text-text-primary","dark:text-white","text-sm","font-medium","leading-normal","hover:text-primary","transition-colors"],["routerLink","/progress",1,"text-text-primary","dark:text-white","text-sm","font-medium","leading-normal","hover:text-primary","transition-colors"],[1,"flex","items-center","gap-3"],[1,"flex","min-w-[84px]","cursor-pointer","items-center","justify-center","overflow-hidden","rounded-full","h-10","px-4","bg-primary","text-text-primary","text-sm","font-bold","leading-normal","shadow-sm","hover:shadow-md","transition-all"],[1,"material-symbols-outlined","!text-[20px]","mr-1"],[1,"truncate"]],template:function(t,i){t&1&&(s(0,"header",0)(1,"a",1)(2,"div",2)(3,"span",3),a(4,"school"),l()(),s(5,"h2",4),a(6,"German Flow"),l()(),s(7,"div",5)(8,"nav",6)(9,"a",7),a(10,"Catalog"),l(),s(11,"a",8),a(12,"My Progress"),l()(),s(13,"div",9)(14,"button",10)(15,"span",11),a(16,"bolt"),l(),s(17,"span",12),a(18),l()(),f(19,"app-auth-button"),l()()()),t&2&&(m(18),Z(i.displayXp()))},dependencies:[ne,U,P],encapsulation:2})};var M=class o{http=n(k);auth=n(g);xpService=n(I);wordsRepo=n(le);progressService=n(pe);pushSubject=new O;isHydrating=!1;lastPushedPayloadString=null;constructor(){b(()=>{this.auth.isAuthenticated()&&(console.log("SyncService: User logged in, triggering pull..."),S(()=>this.pullState()))}),b(()=>{this.xpService.totalXp(),this.xpService.xpLog(),this.wordsRepo.getAll(),this.progressService.lastLessonId(),!this.isHydrating&&(this.auth.isAuthenticated()?S(()=>{this.pushSubject.next()}):S(()=>{localStorage.setItem("gf.sync.localDirty","1"),console.log("SyncService: Local change detected while logged out. Flagging for merge.")}))}),this.pushSubject.pipe(F(2e3),W(()=>this.auth.isAuthenticated()&&!this.isHydrating),V(()=>this.pushState())).subscribe()}pullState(){this.isHydrating=!0,this.http.get(`${c.apiBaseUrl}/state`).pipe(h(()=>console.log("SyncService: Pull success")),_(e=>(console.warn("SyncService: Pull failed",e),x(null)))).subscribe(e=>{if(e)if(localStorage.getItem("gf.sync.localDirty")==="1"){console.log("SyncService: Merging local progress into account...");let i={totalXp:this.xpService.getXp(),xpLog:this.xpService.getLog(),myWords:this.wordsRepo.getAll(),lastLessonId:this.progressService.lastLessonId()},r=this.mergeStates(e,i);S(()=>{this.xpService.hydrate(r.totalXp,r.xpLog),this.wordsRepo.hydrate(r.myWords),this.progressService.hydrate(r.lastLessonId),this.lastPushedPayloadString=JSON.stringify(r),this.http.post(`${c.apiBaseUrl}/state`,r).pipe(h(()=>console.log("SyncService: Merged state pushed successfully")),_(()=>x(null))).subscribe()}),localStorage.removeItem("gf.sync.localDirty")}else S(()=>{this.xpService.hydrate(e.totalXp,e.xpLog||[]),this.wordsRepo.hydrate(e.myWords||[]),this.progressService.hydrate(e.lastLessonId),this.lastPushedPayloadString=JSON.stringify(e)});setTimeout(()=>{this.isHydrating=!1,console.log("SyncService: Hydration lock released")},0)})}mergeStates(e,t){let i=Math.max(e.totalXp||0,t.totalXp||0),r=Array.from(new Set([...e.myWords||[],...t.myWords||[]])),ue=t.lastLessonId||e.lastLessonId,ge=[...e.xpLog||[],...t.xpLog||[]],K=new Map;ge.forEach(w=>K.set(w.ts,w));let he=Array.from(K.values()).sort((w,fe)=>fe.ts-w.ts).slice(0,50);return{totalXp:i,xpLog:he,myWords:r,lastLessonId:ue}}pushState(){if(this.isHydrating)return x(null);let e={totalXp:this.xpService.getXp(),xpLog:this.xpService.getLog(),myWords:this.wordsRepo.getAll(),lastLessonId:this.progressService.lastLessonId()},t=JSON.stringify(e);return t===this.lastPushedPayloadString?(console.log("SyncService: Skipping push, payload unchanged"),x(null)):this.http.post(`${c.apiBaseUrl}/state`,e).pipe(h(()=>{console.log("SyncService: Push success"),this.lastPushedPayloadString=t}),_(i=>(console.warn("SyncService: Push failed",i),x(null))))}static \u0275fac=function(t){return new(t||o)};static \u0275prov=E({token:o,factory:o.\u0275fac,providedIn:"root"})};var N=class o{syncService=n(M);static \u0275fac=function(t){return new(t||o)};static \u0275cmp=u({type:o,selectors:[["app-shell"]],decls:4,vars:0,consts:[[1,"bg-background-light","dark:bg-background-dark","font-display","text-text-primary","antialiased","h-screen","flex","flex-col","overflow-hidden"],[1,"flex-1","flex","flex-col","min-h-0","overflow-hidden"]],template:function(t,i){t&1&&(s(0,"div",0),f(1,"app-header"),s(2,"div",1),f(3,"router-outlet"),l()())},dependencies:[re,B],styles:["[_nghost-%COMP%]{display:block;height:100vh}"]})};var j=class o{static \u0275fac=function(t){return new(t||o)};static \u0275cmp=u({type:o,selectors:[["app-root"]],decls:1,vars:0,template:function(t,i){t&1&&f(0,"app-shell")},dependencies:[N],encapsulation:2})};te(j,me).catch(o=>console.error(o));
